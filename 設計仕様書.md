# AIキャラクター会話システム 設計仕様書

## 📌 はじめに
このシステムは、Unity上で複数のAIキャラクターが自動的に会話をするデモンストレーションです。
OpenAI APIを使用して、キャラクター同士がリアルタイムで会話を生成します。

## 🏗️ システム全体構成

```
[Unity (クライアント)]
        ↕ HTTP/WebSocket
[Python サーバー (Flask)]
        ↕ API Call
    [OpenAI API]
```

### 主要コンポーネント
1. **Unity側**：3D表示、キャラクター制御、UI表示
2. **Pythonサーバー**：会話生成、状態管理、API通信
3. **OpenAI API**：自然な会話テキストの生成

## 🎮 Unity側の構造

### 必要な機能
1. **キャラクター管理**
   - 3体のキャラクターの表示
   - 移動制御（ポイント間の巡回）
   - 近接検知（会話トリガー）

2. **会話表示**
   - 吹き出しUI
   - テキスト表示アニメーション

3. **通信機能**
   - サーバーとのHTTP通信
   - WebSocketでのリアルタイム更新

### 主要スクリプト構成
```
Scripts/
├── Character/
│   ├── CharacterController.cs    # キャラ移動制御
│   ├── CharacterInteraction.cs   # 近接検知・会話開始
│   └── CharacterData.cs         # キャラ個性データ
├── Dialog/
│   ├── DialogManager.cs         # 会話全体制御
│   ├── SpeechBubble.cs         # 吹き出しUI
│   └── DialogData.cs           # 会話データ構造
└── Network/
    ├── ServerConnection.cs      # サーバー通信
    └── WebSocketClient.cs       # WebSocket処理
```

## 🖥️ サーバー側の構造

### ディレクトリ構成
```
server/
├── app.py                 # メインアプリケーション
├── .env                   # 環境変数（APIキー等）
├── requirements.txt       # 依存パッケージ
├── config/
│   └── agents.json       # キャラクター設定
├── services/
│   ├── llm_service.py    # OpenAI API連携
│   └── dialog_service.py # 会話生成ロジック
└── data/
    └── session_state.json # セッション状態
```

### 主要API
```python
# 動作確認
GET /healthz

# キャラクター設定取得
GET /config/agents

# 会話生成（1ターン）
POST /dialog/turn
{
    "agent_ids": ["agent1", "agent2"],
    "context": "前の会話内容",
    "location": "屋台の前"
}
```

## 🔌 Unity-サーバー間通信

### 通信フロー
1. **初期化**
   - Unity起動 → サーバーに接続
   - キャラクター設定を取得

2. **会話開始**
   - キャラ接近を検知
   - サーバーに会話生成リクエスト
   - 応答テキストを吹き出しに表示

3. **会話継続**
   - 6ターン繰り返し
   - 各ターンで交互に発言

### データ形式
```json
// 会話リクエスト
{
    "agent_ids": ["miku", "rin"],
    "turn": 1,
    "previous_dialog": ["こんにちは！"]
}

// 会話レスポンス
{
    "speaker": "rin",
    "text": "こんにちは！夏祭り楽しいね！",
    "emotion": "happy"
}
```

## 🤖 OpenAI API連携

### プロンプト設計
```python
system_prompt = """
あなたは{character_name}というキャラクターです。
性格：{personality}
口調：{speaking_style}
現在の場所：夏祭り会場

以下の条件で会話してください：
- 15〜40文字の短い返答
- 自然な日常会話
- 夏祭りの雰囲気を意識
"""
```

### API設定
- モデル：`gpt-5-mini-2025-08-07` (最新版)
- 最大トークン：100
- 温度：0.8（創造性のバランス）

## 🎭 キャラクター設定

### agents.json構造
```json
{
    "agents": [
        {
            "id": "miku",
            "name": "ミク",
            "personality": "明るく元気",
            "speaking_style": "です・ます調",
            "walking_speed": 1.0,
            "favorite_topics": ["音楽", "歌"]
        }
    ]
}
```

## 🐛 デバッグ機能

### サーバー側
1. **ログ出力**
   - すべてのAPI呼び出しをログ記録
   - エラー詳細を保存

2. **テストモード**
   - `ONLINE=false`でダミー応答
   - APIを使わずに動作確認

### Unity側
1. **デバッグパネル**
   - 通信状態表示
   - キャラクター状態表示
   - エラーログ表示

2. **テストコマンド**
   - F1：システムリセット
   - F2：会話強制開始
   - F3：デバッグ情報表示

## 📋 導入手順（簡易版）

### 1. 環境準備
```bash
# Python環境
python --version  # 3.11以上
pip install -r requirements.txt

# OpenAI APIキー取得
# https://platform.openai.com でキーを作成
```

### 2. サーバー設定
```bash
# .envファイル作成
echo "OPENAI_API_KEY=your-api-key-here" > .env
echo "ONLINE=true" >> .env
```

### 3. 起動手順
```bash
# サーバー起動
cd server
python app.py

# Unity起動
# Unity Editorでプロジェクトを開く
# Playボタンを押す
```

## ⚠️ トラブルシューティング

### よくある問題
1. **接続エラー**
   - サーバーが起動しているか確認
   - ポート5000が使用可能か確認

2. **APIエラー**
   - APIキーが正しいか確認
   - クォータ制限に達していないか確認

3. **キャラが動かない**
   - デバッグパネルでエラー確認
   - F1でリセット試行

## 📊 パフォーマンス目標
- FPS：45〜60fps維持
- 応答時間：2秒以内
- 同時会話：最大6セッション

## 🚀 次のステップ
1. この仕様書を基にコード実装
2. 段階的にテスト（サーバー単体→Unity連携）
3. デバッグ機能を活用して問題解決